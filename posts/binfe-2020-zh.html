<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="author" content="Nick Hageman"><meta http-equiv="X-UA-Compatible" content="chrome=1"><meta name="revisit-after" content="7 days"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/pfp.jpg" type="image/jpeg"><meta name="msapplication-TileColor" content="#ffffff"><title>import { reactive } from 'vue'</title><script>!function(){var e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("vueuse-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script><script type="module" crossorigin="" src="/assets/app-22QfyZ7d.js"></script><link rel="stylesheet" crossorigin="" href="/assets/app-LdrTTJZw.css"><link rel="modulepreload" crossorigin="" href="/assets/binfe-2020-zh-t1rOYVyS.js"><meta property="og:title" content="import { reactive } from 'vue'"><meta name="twitter:title" content="import { reactive } from 'vue'"><meta property="og:image" content="https://antfu.me/og/binfe-2020-zh.png"><meta name="twitter:image" content="https://antfu.me/og/binfe-2020-zh.png"><meta name="twitter:card" content="summary_large_image"></head><body class="font-sans text-gray-700 dark:text-gray-200 relative"><div id="app" data-server-rendered="true"><!--[--><header class="header z-40" data-v-20f56d91=""><a href="/" class="w-12 h-12 absolute xl:fixed m-5 select-none outline-none" focusable="false" data-v-20f56d91=""><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="100%" viewBox="0 0 1134 1235" enable-background="new 0 0 1134 1235" xml:space="preserve" data-v-20f56d91="" data-v-fd85c3e5=""><path fill="#000000" opacity="1.000000" stroke="none" d="
M637.000000,1236.000000 
	C424.666656,1236.000000 212.833328,1236.000000 1.000000,1236.000000 
	C1.000000,824.333313 1.000000,412.666656 1.000000,1.000000 
	C379.000000,1.000000 757.000000,1.000000 1135.000000,1.000000 
	C1135.000000,412.666656 1135.000000,824.333313 1135.000000,1236.000000 
	C969.166687,1236.000000 803.333313,1236.000000 637.000000,1236.000000 
M529.998291,100.794769 
	C529.665649,98.545876 529.014771,96.289444 529.067810,94.049698 
	C529.172607,89.625343 529.908142,85.212746 529.954590,80.790802 
	C530.085693,68.292473 530.007568,55.791862 529.989807,43.292183 
	C529.987915,41.969967 530.058044,40.590496 529.727051,39.334522 
	C525.131287,21.898687 508.277588,8.909043 488.813507,12.979207 
	C481.793152,14.447231 475.648315,17.779093 470.871765,22.833668 
	C464.067017,30.034546 461.468567,39.241390 461.026825,49.002064 
	C460.570648,59.082184 460.210358,69.169922 460.024414,79.258316 
	C459.611176,101.675575 459.383057,124.096222 458.980042,146.513702 
	C458.756744,158.934647 458.413483,171.354828 457.980103,183.770309 
	C457.392273,200.611115 456.642487,217.446198 456.007416,234.285431 
	C455.539032,246.705017 455.385284,259.141235 454.671997,271.545959 
	C451.927307,319.280273 448.549713,366.982819 446.281219,414.738647 
	C443.467041,473.983185 439.880768,533.259277 439.537109,592.538635 
	C438.817291,716.692566 440.002380,840.857544 440.404358,965.017944 
	C440.410370,966.871033 440.405090,968.724121 440.405090,970.577209 
	C437.435974,962.986694 435.584991,955.294922 433.559418,947.649353 
	C420.652466,898.932678 408.004883,850.148254 399.651611,800.394714 
	C395.573517,776.105042 392.679169,751.610657 388.333679,727.373108 
	C380.260559,682.344116 371.778870,637.384155 362.985535,592.489746 
	C351.906525,535.925903 344.621674,478.810272 337.017670,421.724609 
	C330.733734,374.549103 325.608002,327.204865 316.104919,280.485565 
	C310.586182,253.354401 304.309082,226.487335 295.039154,200.358841 
	C291.383881,190.056015 284.782806,182.247559 275.462494,177.019562 
	C257.307922,166.836227 235.845154,175.276825 229.216263,195.555191 
	C225.983826,205.443527 224.712418,216.021805 223.080109,226.370865 
	C221.381378,237.141068 220.323975,248.012222 218.974503,258.837769 
	C217.322662,272.088959 215.527847,285.324036 214.041138,298.593628 
	C212.838837,309.324890 211.757507,320.081268 211.062347,330.854889 
	C210.148972,345.010345 209.247467,359.188293 209.068451,373.365784 
	C207.986359,459.058533 212.281219,544.607422 215.472961,630.207092 
	C218.800018,719.435852 222.536758,808.767151 213.896942,897.957886 
	C212.311783,914.321899 210.176300,930.641357 207.912140,946.928162 
	C205.881546,961.534973 203.232742,976.054810 201.034622,990.639832 
	C199.797638,998.847412 198.981339,1007.117554 197.865494,1015.344604 
	C196.642975,1024.358032 195.240173,1033.346924 194.013840,1042.359985 
	C192.631821,1052.517334 191.087997,1062.664795 190.153839,1072.865845 
	C189.692535,1077.903320 189.705383,1083.216431 190.796463,1088.116821 
	C193.250961,1099.140747 203.567688,1104.718750 212.970551,1103.801025 
	C223.287079,1102.793945 230.689514,1097.532959 232.891876,1086.368896 
	C234.742386,1076.988403 235.536026,1067.404663 237.063797,1057.954102 
	C239.596161,1042.289307 242.389709,1026.666870 244.984879,1011.012085 
	C247.475677,995.986877 249.481323,980.871399 252.350540,965.920471 
	C261.785004,916.759277 267.900299,867.130127 269.518219,817.184692 
	C271.535736,754.904480 271.835999,692.556519 272.087036,630.234680 
	C272.329346,570.076599 271.560211,509.914520 271.251160,449.754120 
	C271.204834,440.735992 271.244720,431.717407 271.244720,422.699036 
	C271.785217,422.693085 272.325714,422.687134 272.866211,422.681213 
	C273.708435,430.924377 274.438965,439.180786 275.413086,447.408386 
	C278.897766,476.841187 282.009491,506.328033 286.122192,535.673950 
	C290.740906,568.630066 295.666077,601.568726 301.583191,634.311584 
	C310.575500,684.071167 320.593597,733.644775 330.064392,783.318726 
	C335.017853,809.299561 338.502197,835.629578 344.828308,861.264343 
	C355.897552,906.119263 368.778229,950.524658 380.649841,995.184875 
	C390.433289,1031.989746 404.260895,1067.257202 419.922546,1101.892578 
	C425.992645,1115.316406 431.587219,1128.971191 436.940369,1142.699341 
	C443.035400,1158.329956 460.196564,1167.794067 476.430756,1162.173584 
	C488.924957,1157.848145 499.731110,1142.798340 499.991272,1128.507935 
	C500.143799,1120.130005 500.120697,1111.748535 500.326752,1103.372192 
	C500.982452,1076.717041 501.790009,1050.065186 502.392914,1023.408875 
	C504.627502,924.607910 506.697052,825.803162 509.056824,727.005310 
	C509.936157,690.188782 511.233307,653.378784 512.719360,616.581116 
	C514.332947,576.624023 516.391846,536.684937 518.249878,496.737610 
	C520.030396,458.455719 521.764587,420.171631 523.588013,381.891754 
	C525.686035,337.847015 528.149841,293.817291 529.886353,249.758652 
	C530.854370,225.198334 530.743042,200.593109 530.944336,176.006699 
	C530.991455,170.257339 530.083008,164.503799 530.046143,158.749435 
	C529.924438,139.750656 530.000427,120.750618 529.998291,100.794769 
M864.000427,321.500000 
	C864.000427,268.670380 864.002380,215.840759 863.998962,163.011139 
	C863.998230,151.502319 855.842651,143.186630 842.705872,141.275009 
	C834.262268,140.046341 822.533447,148.752426 821.155212,158.391586 
	C819.766357,168.104919 819.533020,177.995651 819.036316,187.820938 
	C818.535339,197.730804 818.343750,207.656128 817.996338,217.573975 
	C817.678101,226.659546 817.261169,235.742233 817.015564,244.829666 
	C816.621460,259.412537 816.304443,273.997681 816.007935,288.582947 
	C815.752747,301.141998 815.868286,313.715851 815.306091,326.260162 
	C813.015808,377.359863 810.174805,428.437073 808.202026,479.548279 
	C805.708435,544.151733 803.857544,608.780090 801.752014,673.398438 
	C801.639832,676.840759 801.737488,680.289978 801.737488,683.696594 
	C767.505371,683.147461 735.920593,694.387512 703.261780,699.093567 
	C703.261780,696.283081 703.199341,693.797546 703.271118,691.315857 
	C704.504578,648.676147 706.723450,606.039001 706.812134,563.397278 
	C707.041870,453.001587 706.330750,342.603943 706.005920,232.207062 
	C705.969177,219.708374 706.093201,207.208328 705.937256,194.711487 
	C705.897156,191.499542 705.632202,188.085388 704.508606,185.129883 
	C700.931946,175.722275 693.559082,170.665619 683.745117,170.482819 
	C674.885925,170.317810 667.538330,174.730530 664.229492,183.021667 
	C662.012695,188.576263 661.355286,194.985229 661.121277,201.055130 
	C660.443787,218.626099 660.335327,236.218948 659.997742,253.803116 
	C659.898804,258.955841 659.794800,264.108551 659.668396,269.260620 
	C659.125000,291.414459 658.073975,313.568939 658.111816,335.721619 
	C658.255188,419.734467 655.975708,503.694061 651.608154,587.568542 
	C648.403259,649.115295 643.503052,710.575134 639.216553,772.063843 
	C635.497864,825.407471 631.473938,878.729858 627.777832,932.074951 
	C623.421692,994.945618 621.308472,1057.873291 624.045654,1120.885376 
	C624.379395,1128.568848 624.949341,1136.286499 626.121643,1143.878296 
	C627.722412,1154.244751 630.454895,1164.443726 631.893677,1174.826538 
	C634.138550,1191.026489 649.403015,1203.444824 665.383240,1203.125977 
	C686.263550,1202.709473 702.064148,1183.286987 697.464355,1161.744263 
	C695.436279,1152.245728 693.949402,1142.566650 693.126221,1132.892090 
	C692.047607,1120.215942 691.354187,1107.461426 691.393555,1094.743408 
	C691.546143,1045.419434 691.461975,996.082703 692.605774,946.777100 
	C693.652771,901.641296 696.140625,856.538330 698.051453,811.423340 
	C699.002441,788.968994 700.082947,766.520203 701.106445,744.035461 
	C702.090027,743.715942 702.856079,743.360168 703.659607,743.221558 
	C727.107239,739.177429 750.537354,735.023499 774.020752,731.197571 
	C782.616394,729.797241 791.340149,729.182922 799.560669,728.259949 
	C799.560669,741.169128 799.789185,752.825317 799.523621,764.470276 
	C797.806213,839.775146 795.619446,915.077942 798.169739,990.404297 
	C798.883118,1011.476807 799.981018,1032.539185 801.158081,1053.591919 
	C801.843140,1065.844727 803.027161,1078.069702 804.002441,1090.306030 
	C804.652893,1098.466187 805.069946,1106.655518 806.049072,1114.776611 
	C808.303040,1133.471558 828.333862,1146.802124 846.971191,1141.969849 
	C860.896545,1138.359375 871.655762,1125.911133 871.911865,1113.178101 
	C872.067322,1105.449829 871.437195,1097.697754 870.981201,1089.966797 
	C870.051697,1074.207031 868.900452,1058.459961 868.030762,1042.697021 
	C867.265808,1028.830444 866.739990,1014.950378 866.144592,1001.074768 
	C865.080383,976.270813 863.563049,951.474915 863.090027,926.659302 
	C861.943604,866.513184 861.072449,806.359802 860.481567,746.205505 
	C859.312683,627.218872 859.227417,508.235382 862.631531,389.273468 
	C863.268250,367.020782 863.553162,344.758087 864.000427,321.500000 
z" data-v-fd85c3e5=""></path><path fill="#FEFEFE" opacity="1.000000" stroke="none" d="
M529.999451,101.272919 
	C530.000427,120.750618 529.924438,139.750656 530.046143,158.749435 
	C530.083008,164.503799 530.991455,170.257339 530.944336,176.006699 
	C530.743042,200.593109 530.854370,225.198334 529.886353,249.758652 
	C528.149841,293.817291 525.686035,337.847015 523.588013,381.891754 
	C521.764587,420.171631 520.030396,458.455719 518.249878,496.737610 
	C516.391846,536.684937 514.332947,576.624023 512.719360,616.581116 
	C511.233307,653.378784 509.936157,690.188782 509.056824,727.005310 
	C506.697052,825.803162 504.627502,924.607910 502.392914,1023.408875 
	C501.790009,1050.065186 500.982452,1076.717041 500.326752,1103.372192 
	C500.120697,1111.748535 500.143799,1120.130005 499.991272,1128.507935 
	C499.731110,1142.798340 488.924957,1157.848145 476.430756,1162.173584 
	C460.196564,1167.794067 443.035400,1158.329956 436.940369,1142.699341 
	C431.587219,1128.971191 425.992645,1115.316406 419.922546,1101.892578 
	C404.260895,1067.257202 390.433289,1031.989746 380.649841,995.184875 
	C368.778229,950.524658 355.897552,906.119263 344.828308,861.264343 
	C338.502197,835.629578 335.017853,809.299561 330.064392,783.318726 
	C320.593597,733.644775 310.575500,684.071167 301.583191,634.311584 
	C295.666077,601.568726 290.740906,568.630066 286.122192,535.673950 
	C282.009491,506.328033 278.897766,476.841187 275.413086,447.408386 
	C274.438965,439.180786 273.708435,430.924377 272.866211,422.681213 
	C272.325714,422.687134 271.785217,422.693085 271.244720,422.699036 
	C271.244720,431.717407 271.204834,440.735992 271.251160,449.754120 
	C271.560211,509.914520 272.329346,570.076599 272.087036,630.234680 
	C271.835999,692.556519 271.535736,754.904480 269.518219,817.184692 
	C267.900299,867.130127 261.785004,916.759277 252.350540,965.920471 
	C249.481323,980.871399 247.475677,995.986877 244.984879,1011.012085 
	C242.389709,1026.666870 239.596161,1042.289307 237.063797,1057.954102 
	C235.536026,1067.404663 234.742386,1076.988403 232.891876,1086.368896 
	C230.689514,1097.532959 223.287079,1102.793945 212.970551,1103.801025 
	C203.567688,1104.718750 193.250961,1099.140747 190.796463,1088.116821 
	C189.705383,1083.216431 189.692535,1077.903320 190.153839,1072.865845 
	C191.087997,1062.664795 192.631821,1052.517334 194.013840,1042.359985 
	C195.240173,1033.346924 196.642975,1024.358032 197.865494,1015.344604 
	C198.981339,1007.117554 199.797638,998.847412 201.034622,990.639832 
	C203.232742,976.054810 205.881546,961.534973 207.912140,946.928162 
	C210.176300,930.641357 212.311783,914.321899 213.896942,897.957886 
	C222.536758,808.767151 218.800018,719.435852 215.472961,630.207092 
	C212.281219,544.607422 207.986359,459.058533 209.068451,373.365784 
	C209.247467,359.188293 210.148972,345.010345 211.062347,330.854889 
	C211.757507,320.081268 212.838837,309.324890 214.041138,298.593628 
	C215.527847,285.324036 217.322662,272.088959 218.974503,258.837769 
	C220.323975,248.012222 221.381378,237.141068 223.080109,226.370865 
	C224.712418,216.021805 225.983826,205.443527 229.216263,195.555191 
	C235.845154,175.276825 257.307922,166.836227 275.462494,177.019562 
	C284.782806,182.247559 291.383881,190.056015 295.039154,200.358841 
	C304.309082,226.487335 310.586182,253.354401 316.104919,280.485565 
	C325.608002,327.204865 330.733734,374.549103 337.017670,421.724609 
	C344.621674,478.810272 351.906525,535.925903 362.985535,592.489746 
	C371.778870,637.384155 380.260559,682.344116 388.333679,727.373108 
	C392.679169,751.610657 395.573517,776.105042 399.651611,800.394714 
	C408.004883,850.148254 420.652466,898.932678 433.559418,947.649353 
	C435.584991,955.294922 437.435974,962.986694 440.405090,970.577209 
	C440.405090,968.724121 440.410370,966.871033 440.404358,965.017944 
	C440.002380,840.857544 438.817291,716.692566 439.537109,592.538635 
	C439.880768,533.259277 443.467041,473.983185 446.281219,414.738647 
	C448.549713,366.982819 451.927307,319.280273 454.671997,271.545959 
	C455.385284,259.141235 455.539032,246.705017 456.007416,234.285431 
	C456.642487,217.446198 457.392273,200.611115 457.980103,183.770309 
	C458.413483,171.354828 458.756744,158.934647 458.980042,146.513702 
	C459.383057,124.096222 459.611176,101.675575 460.024414,79.258316 
	C460.210358,69.169922 460.570648,59.082184 461.026825,49.002064 
	C461.468567,39.241390 464.067017,30.034546 470.871765,22.833668 
	C475.648315,17.779093 481.793152,14.447231 488.813507,12.979207 
	C508.277588,8.909043 525.131287,21.898687 529.727051,39.334522 
	C530.058044,40.590496 529.987915,41.969967 529.989807,43.292183 
	C530.007568,55.791862 530.085693,68.292473 529.954590,80.790802 
	C529.908142,85.212746 529.172607,89.625343 529.067810,94.049698 
	C529.014771,96.289444 529.665649,98.545876 529.999451,101.272919 
z" data-v-fd85c3e5=""></path><path fill="#FEFEFE" opacity="1.000000" stroke="none" d="
M864.000427,322.000000 
	C863.553162,344.758087 863.268250,367.020782 862.631531,389.273468 
	C859.227417,508.235382 859.312683,627.218872 860.481567,746.205505 
	C861.072449,806.359802 861.943604,866.513184 863.090027,926.659302 
	C863.563049,951.474915 865.080383,976.270813 866.144592,1001.074768 
	C866.739990,1014.950378 867.265808,1028.830444 868.030762,1042.697021 
	C868.900452,1058.459961 870.051697,1074.207031 870.981201,1089.966797 
	C871.437195,1097.697754 872.067322,1105.449829 871.911865,1113.178101 
	C871.655762,1125.911133 860.896545,1138.359375 846.971191,1141.969849 
	C828.333862,1146.802124 808.303040,1133.471558 806.049072,1114.776611 
	C805.069946,1106.655518 804.652893,1098.466187 804.002441,1090.306030 
	C803.027161,1078.069702 801.843140,1065.844727 801.158081,1053.591919 
	C799.981018,1032.539185 798.883118,1011.476807 798.169739,990.404297 
	C795.619446,915.077942 797.806213,839.775146 799.523621,764.470276 
	C799.789185,752.825317 799.560669,741.169128 799.560669,728.259949 
	C791.340149,729.182922 782.616394,729.797241 774.020752,731.197571 
	C750.537354,735.023499 727.107239,739.177429 703.659607,743.221558 
	C702.856079,743.360168 702.090027,743.715942 701.106445,744.035461 
	C700.082947,766.520203 699.002441,788.968994 698.051453,811.423340 
	C696.140625,856.538330 693.652771,901.641296 692.605774,946.777100 
	C691.461975,996.082703 691.546143,1045.419434 691.393555,1094.743408 
	C691.354187,1107.461426 692.047607,1120.215942 693.126221,1132.892090 
	C693.949402,1142.566650 695.436279,1152.245728 697.464355,1161.744263 
	C702.064148,1183.286987 686.263550,1202.709473 665.383240,1203.125977 
	C649.403015,1203.444824 634.138550,1191.026489 631.893677,1174.826538 
	C630.454895,1164.443726 627.722412,1154.244751 626.121643,1143.878296 
	C624.949341,1136.286499 624.379395,1128.568848 624.045654,1120.885376 
	C621.308472,1057.873291 623.421692,994.945618 627.777832,932.074951 
	C631.473938,878.729858 635.497864,825.407471 639.216553,772.063843 
	C643.503052,710.575134 648.403259,649.115295 651.608154,587.568542 
	C655.975708,503.694061 658.255188,419.734467 658.111816,335.721619 
	C658.073975,313.568939 659.125000,291.414459 659.668396,269.260620 
	C659.794800,264.108551 659.898804,258.955841 659.997742,253.803116 
	C660.335327,236.218948 660.443787,218.626099 661.121277,201.055130 
	C661.355286,194.985229 662.012695,188.576263 664.229492,183.021667 
	C667.538330,174.730530 674.885925,170.317810 683.745117,170.482819 
	C693.559082,170.665619 700.931946,175.722275 704.508606,185.129883 
	C705.632202,188.085388 705.897156,191.499542 705.937256,194.711487 
	C706.093201,207.208328 705.969177,219.708374 706.005920,232.207062 
	C706.330750,342.603943 707.041870,453.001587 706.812134,563.397278 
	C706.723450,606.039001 704.504578,648.676147 703.271118,691.315857 
	C703.199341,693.797546 703.261780,696.283081 703.261780,699.093567 
	C735.920593,694.387512 767.505371,683.147461 801.737488,683.696594 
	C801.737488,680.289978 801.639832,676.840759 801.752014,673.398438 
	C803.857544,608.780090 805.708435,544.151733 808.202026,479.548279 
	C810.174805,428.437073 813.015808,377.359863 815.306091,326.260162 
	C815.868286,313.715851 815.752747,301.141998 816.007935,288.582947 
	C816.304443,273.997681 816.621460,259.412537 817.015564,244.829666 
	C817.261169,235.742233 817.678101,226.659546 817.996338,217.573975 
	C818.343750,207.656128 818.535339,197.730804 819.036316,187.820938 
	C819.533020,177.995651 819.766357,168.104919 821.155212,158.391586 
	C822.533447,148.752426 834.262268,140.046341 842.705872,141.275009 
	C855.842651,143.186630 863.998230,151.502319 863.998962,163.011139 
	C864.002380,215.840759 864.000427,268.670380 864.000427,322.000000 
z" data-v-fd85c3e5=""></path></svg></a><button title="Scroll to top" fixed="" right-3="" bottom-3="" w-10="" h-10="" hover:op100="" rounded-full="" hover-bg-hex-8883="" transition="" duration-300="" z-100="" print:hidden="" class="op0! pointer-events-none" data-v-20f56d91=""><div i-ri-arrow-up-line="" data-v-20f56d91=""></div></button><nav class="nav" data-v-20f56d91=""><div class="spacer" data-v-20f56d91=""></div><div class="right" print:op0="" data-v-20f56d91=""><a href="/demos" class="" title="Projects" data-v-20f56d91=""><span class="lt-md:hidden" data-v-20f56d91="">Demos</span><div i-ri-screenshot-line="" class="md:hidden" data-v-20f56d91=""></div></a><a href="https://github.com/Nick-Hageman" target="_blank" title="GitHub" class="lt-md:hidden" data-v-20f56d91=""><div i-uil-github-alt="" data-v-20f56d91=""></div></a><a class="select-none" title="Toggle Color Scheme" data-v-20f56d91=""><div i-ri-sun-line="" dark:i-ri-moon-line=""></div></a></div></nav></header><main class="px-7 py-10 of-x-hidden"><!--[--><!----><div class="prose m-auto mb-8"><h1 class="mb-0 slide-enter-50">import { reactive } from 'vue'</h1><p class="opacity-50 !-mt-6 slide-enter-50">Sep 26, 2020 <span>· 25min</span></p><p class="mt--4!"><span op50="">at </span><span font-bold="">滨江前端沙龙 2020</span></p><!----><!----></div><article class=""><!--[--><div class="prose m-auto slide-enter-content"><blockquote><p>这是我在2020滨江前端沙龙分享的文稿</p><p>This is the transcript of my talk at BinFE 2020</p><p>Slides: <a href="https://antfu.me/talks/2020-09-26" target="_blank" rel="noopener">中文 ver.</a> | <a href="https://antfu.me/talks/2020-09-26/en" target="_blank" rel="noopener">English ver.</a></p></blockquote><p>Hello 大家好，非常感谢丁香园这次的邀请，也非常荣幸能够参与这次的分享。我是第一次做这样的分享，不足之处还请多多指教。</p><p>我这次分享的主题是 <code>import { reactive } from 'vue'</code>，和大家简单聊一聊 Vue 3 的响应式和组合式，以及他们的一些应用。</p><p>我叫 Anthony Fu，是 Vue 的 Core Team 的一员，我在 Vue 主要负责 @vue/composition-api 这个项目的维护。这是一个面向 Vue 2 的插件，它在 Vue 2 中增加了 Vue 3 的 Composition API 的支持。我最近也加入了 Vite 负责一些 Code Review 的工作。可以在下面这些平台找到我。</p><ul><li>GitHub <a href="https://github.com/antfu" target="_blank" rel="noopener">@antfu</a></li><li>Twitter <a href="https://twitter.com/antfu7" target="_blank" rel="noopener">@antfu7</a></li><li>Blog <a href="https://antfu.me" target="_blank" rel="noopener">antfu.me</a></li></ul><h3 id="介绍" tabindex="-1">介绍 <a class="header-anchor" href="#介绍" aria-hidden="true">#</a></h3><p>我这次分享的主要会和大家简单介绍一下响应式与组合式 API，然后通过一个例子的形式介绍组合式 API 所带来的优势。再来，我会以一个工具库作者的角度跟大家聊一聊如何做到 Vue 2 与 Vue 3 双版本同时兼容的同构。最后，我会去再介绍一下响应式 API 的一些延伸应用。</p><p>庆祝 Vue 3.0 One Piece 在上个礼拜正式发布！</p><p>大家知道，在 Vue 3.0 中我们使用 TypeScript 进行了一次从零的重写。利用这次重写的机会，我们对整个 Repo 的结构进行了一些解构，把 Vue 拆分成了这几个独立的库。在这一次的分享中我会主要会面向比较底层的响应式（<code>@vue/reactivity</code>）和组合式（<code>@vue/runtime-core</code>）这两个模块进行讨论。</p><h3 id="响应式-reactivity-api" tabindex="-1">响应式 Reactivity API <a class="header-anchor" href="#响应式-reactivity-api" aria-hidden="true">#</a></h3><p>那么什么是响应式呢？提到这个就得祭出这张非常经典的 GIF。在一个 Excel 表格里面，我们会以公示的形式去定义一个一个单元格应该去做怎么样的一个运算。那么大家可以看到，在我设置好了 <code>A3</code> 这个格子的公式之后，我去更新 <code>A1</code> 的数值时， <code>A3</code> 就会自动更新，而我不需要再去做任何的操作。这就是响应是能够给我们带来的一个非常好的帮助，依赖的自动收集跟更新。</p><p>在 Vue 3 里面，我们对整个响应式系统做了一个重新的设计，同时暴露出了这几个新的API，<code>ref</code> <code>reactive</code> <code>computed</code> <code>effect</code>。我们把原本 Vue 2 <code>Object.defineProperty</code> 的实现改成了使用 <code>Proxy</code> 的实现方式。而 Proxy 可以给我们提供对属性更新监控的更大的灵活性。</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> reactive</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> new</span><span style="--s-dark:#80A665;--s-light:#59873A"> Proxy</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    get</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">prop</span><span style="--s-dark:#666666;--s-light:#999999">, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">receiver</span><span style="--s-dark:#666666;--s-light:#999999">) {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">      track</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">prop</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Reflect</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">get</span><span style="--s-dark:#666666;--s-light:#999999">(...</span><span style="--s-dark:#C99076;--s-light:#A65E2B">arguments</span><span style="--s-dark:#666666;--s-light:#999999">) </span><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// get original data</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    },</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    set</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">key</span><span style="--s-dark:#666666;--s-light:#999999">, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">receiver</span><span style="--s-dark:#666666;--s-light:#999999">) {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">      trigger</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">key</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Reflect</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">set</span><span style="--s-dark:#666666;--s-light:#999999">(...</span><span style="--s-dark:#C99076;--s-light:#A65E2B">arguments</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  })</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">obj</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> reactive</span><span style="--s-dark:#666666;--s-light:#999999">({</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">  hello</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">world</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">})</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">obj</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">hello</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#758575DD;--s-light:#A0ADA0"> // `track()` get called</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">obj</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">hello</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">vue</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#758575DD;--s-light:#A0ADA0"> // `trigger()` get called</span></span></code></pre><p>我们可以通过 <code>get</code> 和 <code>set</code> 这两个 handler 去追踪每一个属性的访问和修改，在这个例子中我们在 <code>get</code> 里注入了 <code>track</code> 这个函数，在 <code>set</code> 里注入了<code>trigger</code> 这个函数。那么在对 <code>reactive</code> 这个对象的 <code>hello</code> 属性进行访问的时候 <code>track</code> 就会被执行，在对 <code>obj.hello</code> 进行赋值的时候，<code>trigger</code> 就会被执行。通过 <code>track</code> 和 <code>trigger</code> 我们就可以进行一些响应式的追踪。</p><h4 id="effect" tabindex="-1">Effect <a class="header-anchor" href="#effect" aria-hidden="true">#</a></h4><p><code>effect</code> 是在 Vue 3 里面新引入的一个API，它的作用就是去结合 <code>track</code> 和 <code>trigger</code> 这两个功能，<code>track</code> 的作用是追踪调用他的函数，<code>trigger</code> 是去触发绑定的依赖更新。</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">targetMap</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> new </span><span style="--s-dark:#80A665;--s-light:#59873A">WeakMap</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> track</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> key</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">tacking</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> activeEffect</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    targetMap</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">get</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">).</span><span style="--s-dark:#80A665;--s-light:#59873A">key</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">key</span><span style="--s-dark:#666666;--s-light:#999999">).</span><span style="--s-dark:#80A665;--s-light:#59873A">push</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">activeEffect</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> trigger</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> key</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  targetMap</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">get</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">).</span><span style="--s-dark:#80A665;--s-light:#59873A">key</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">key</span><span style="--s-dark:#666666;--s-light:#999999">).</span><span style="--s-dark:#80A665;--s-light:#59873A">forEach</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">effect</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#80A665;--s-light:#59873A"> effect</span><span style="--s-dark:#666666;--s-light:#999999">())</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> effect</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">fn</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#80A665;--s-light:#59873A">effect</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function </span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    fn</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  enableTracking</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  activeEffect</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> effect</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  fn</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  resetTracking</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  activeEffect</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> undefined</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>在 <code>effect</code> 里面我们会接受一个函数作为参数，在执行这个函数之前的我们会开启 tracking，然后把当前的函数设置在一个全局变量 <code>activeEffect</code>，然后再去执行这个函数。那么在这个函数的调用时间里面我们有任何的 reactive 的调用就会触发 <code>track</code> 这个函数。<code>track</code> 的主要功能就是说我们把当前的 <code>activeEffect</code> 绑定到所触发它的这个属性调用上。然后在数据更新的时候，我们再去找到这个依赖上面所绑定的所有 <code>effect</code> 把他们一一调用。这样就完成了一个最基本的响应式的功能。</p><h4 id="computed-watch" tabindex="-1"><code>computed</code> &amp; <code>watch</code> <a class="header-anchor" href="#computed-watch" aria-hidden="true">#</a></h4><p>在 Vue 3.0 里面，<code>computed</code> 和 <code>watch</code> 都是基于 <code>effect</code> 的包装，我们这边可以看到一个简单的 <code>computed</code> 的实现</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> computed</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">getter</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">dirty</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">runner</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> effect</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">getter</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    lazy</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#4D9375;--s-light:#1E754F">true</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    scheduler</span><span style="--s-dark:#666666;--s-light:#999999">() {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      dirty</span><span style="--s-dark:#666666;--s-light:#999999"> = </span><span style="--s-dark:#4D9375;--s-light:#1E754F">true</span><span style="--s-dark:#758575DD;--s-light:#A0ADA0"> // deps changed</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  })</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    get</span><span style="--s-dark:#80A665;--s-light:#59873A"> value</span><span style="--s-dark:#666666;--s-light:#999999">() {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">dirty</span><span style="--s-dark:#666666;--s-light:#999999">) {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        value</span><span style="--s-dark:#666666;--s-light:#999999"> = </span><span style="--s-dark:#80A665;--s-light:#59873A">runner</span><span style="--s-dark:#666666;--s-light:#999999">() </span><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// re-evaluate</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        dirty</span><span style="--s-dark:#666666;--s-light:#999999"> = </span><span style="--s-dark:#4D9375;--s-light:#1E754F">false</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> value</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p><code>computed</code> 接受一个 getter 函数，这个函数我们把它直接传给 <code>effect</code>，<code>effect</code>会在先执行一次进行依赖收集，在收集完了之后，如果里面其中的依赖发生了变动，他就会触发这个 <code>scheduler</code> 将 <code>dirty</code> 设置为 <code>true</code>。在最后我们在对 <code>computed</code> 进行求值的时候，如果 <code>dirty</code> 为 <code>true</code>，我们就会重新进行一次运算得到新的 <code>value</code> 后再把 <code>value</code> 传出去。在第二次调用时，如果里面的依赖没有更新，我们就可以直接用上一次计算的结果，这件可以避免掉多余重复的计算。这里有一些 <a href="https://antfu.me/posts/watch-with-reactivity/" target="_blank" rel="noopener">延伸阅读</a>，大家如果有兴趣去了解一些比较深入的原理的话也可以去看一看。</p><h3 id="组合式-composition-api" tabindex="-1">组合式 Composition API <a class="header-anchor" href="#组合式-composition-api" aria-hidden="true">#</a></h3><p>那么聊完了响应式，我们再来看看什么是组合式。</p><p>组合式其实是基于响应式延伸出来的一套和 Vue 生命周期绑定的一套工具。它提供了 Vue 生命周期的钩子像是 <code>onMounted</code> <code>onUpdate</code> 和 <code>onUnmounted</code> 等等。还有个非常重要的功能就是说在 Vue 的 <code>setup()</code> 里面，所建立的类似 <code>computed</code> 或者 <code>watch</code> 的 <code>effect</code> 会在组件销毁的时候自动跟随这个组件一并销毁。那么组合是最重要的作用就是它可以提供可复用的逻辑，我们可以把很多的逻辑拆分出来，做成一个一个的工具。然后可以跨组件的进行复用或甚至是把它做成一个第三方库，跨应用地进行复用。这个我们会在之后进行详细的介绍。</p><p>响应式是跟组合式的区别，就是他们是有两个不同的包提供的，在整个 Vue 应用的角度来看的话 ，这些 API 都会从 <code>vue</code> 这个包里面统一导出的。但是如果我们会我们想要使用其中的一部分的话，那么可以看到 <code>ref</code> <code>reactive</code> <code>computed</code> <code>effect</code> 是在 <code>@vue/reactivity</code> 这个包里导出的，然后像是 <code>watch</code> <code>setup</code> 和一些生命周期是在 <code>@vue/runtime-core</code> 这个包里导出的。可以注意到一点也是非常有趣的一点，就是 <code>@vue/reactivity</code> 这个包其实是可以作为一个独立的包使用的，也就是说我可以不依赖于 Vue，我可以基于这个自己做一个框架，甚至我可以在 Node.js，在没有 UI 的环境下去进行使用。这个也会在我们后面的PPT里面去做一个比较详细的介绍。</p><h3 id="case-study" tabindex="-1">Case Study <a class="header-anchor" href="#case-study" aria-hidden="true">#</a></h3><p>那我们来看一个简单的使用场景的一个例子，这里有一个需求，我们现在想给我们的网页实现一个 Dark Mode 这个功能。我希望整个页面在默认的情况下会随着我系统的系统的偏好改变。然后我可能希望一个用户有一个手动可以修改的功能，比如说我有一个按钮一个直接改变 Dark Mode。 然后又希望这个这个功能是一个可持久化的，我可以保存下用户的偏好，在网页刷新后还可以还可以继续存留用户的上一次的修改。最后可能会希望说在两个模式切换的时候去执行一些代码，比如说通知用户或者是通知组件进行一些操作之类的。</p><h4 id="基础实现" tabindex="-1">基础实现 <a class="header-anchor" href="#基础实现" aria-hidden="true">#</a></h4><p>那我们看一下我们怎么去实现这样一个功能。我们假设说 Dark Mode 已经在CSS层面上都做好了，也就是说我把 <code>dark</code> class 加上的时候，整个页面就会变成黑暗模式。那么我再提供一个按钮去给用户做切换。这个就是我们提供的模板的部分</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-vue"><span class="line"><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">template</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  &lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">div</span><span style="--s-dark:#666666;--s-light:#999999"> :</span><span style="--s-dark:#80A665;--s-light:#59873A">class</span><span style="--s-dark:#666666;--s-light:#999999">=</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">"</span><span style="--s-dark:#666666;--s-light:#999999">{</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> dark</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">"</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    &lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">button</span><span style="--s-dark:#666666;--s-light:#999999"> @</span><span style="--s-dark:#80A665;--s-light:#59873A">click</span><span style="--s-dark:#666666;--s-light:#999999">=</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">"</span><span style="--s-dark:#BD976A;--s-light:#B07D48">toggleDark</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">"</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">      Toggle</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    &lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">button</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  &lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">div</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">&lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">template</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span></code></pre><p>我们再来看代码的部分要怎么实现</p><p>那么在 Options API 里面，非常的简单，我们可以这样实现：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-vue"><span class="line"><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">script</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> default</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  data</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">      dark</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">  methods</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    toggleDark</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">      this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">dark</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">dark</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    },</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">&lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">script</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span></code></pre><p>那在 Composition API 里面，我们可以把 <code>dark</code> 变成 <code>ref</code>。这个 <code>dark</code> 会直接从<code>setup()</code> 里面传出去，那我们同时可以在 return 里面传一个叫做 <code>toggleDark</code> 的函数，然后我们也是一样对 <code>dark</code> 进行取反。这样我们就实现了一个简单的开关的功能。</p><h4 id="系统偏好" tabindex="-1">系统偏好 <a class="header-anchor" href="#系统偏好" aria-hidden="true">#</a></h4><p>再来的话，我们希望去增加用户系统偏好的更新。我们可以通过一个浏览器提供的 API <code>window.matchMedia</code>。然后再利用一个 CSS 的 Query <code>(prefers-color-scheme: dark)</code>，我们就可以知道是用户的系统的颜色偏好。然后我们会我们可以对这个 <code>matchMedia</code> 调用 <code>addEvenetListener</code> 进行监听，那么在用户系统改变的时候，我们可以随之一起改变。</p><p>那么为了实现这样一个功能的话，在 Options API 里面我们需要在需要将 <code>media</code> 暴露在 Vue 实例上，然后在 <code>created</code> 中进行事件的绑定，同时在 <code>destroyed</code> 的时候再把这个事件监听注销。</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-vue"><span class="line"><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">script</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// Options API</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> default</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  data</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">      dark</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">      media</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> window</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">matchMedia</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">(prefers-color-scheme: dark)</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">),</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  created</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">media</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">addEventListener</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">change</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">update</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">update</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  unmounted</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">media</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">removeEventListener</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">change</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">update</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">  methods</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    toggleDark</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">      this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">dark</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">dark</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    },</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    update</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">      this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">dark</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">media</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">matches</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    },</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">&lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">script</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span></code></pre><p>那么再来看看 Composition API 要怎么实现。我们直接定义这个 <code>media</code>,</p><p>然后因为在 Composition API 中，<code>setup()</code> 相当于 Options API 的 <code>created</code>，我们直接可以把 <code>addEventListener</code> 的直接写在 <code>setup()</code> 里面，对应的我们再通过一个生命周期的钩子 <code>OnUnmounted</code> 注销事件监听。</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-vue"><span class="line"><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">script</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// Composition API</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">import</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> onUnmounted</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> ref</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> from</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">vue</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> default</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  setup</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> media</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> window</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">matchMedia</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">(prefers-color-scheme: dark)</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> dark</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> ref</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">media</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">matches</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const</span><span style="--s-dark:#80A665;--s-light:#59873A"> update</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">dark</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> media</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">matches</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    media</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">addEventListener</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">change</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> update</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    onUnmounted</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      media</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">removeEventListener</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">change</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> update</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    })</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      dark</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">      toggleDark</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        dark</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !</span><span style="--s-dark:#BD976A;--s-light:#B07D48">dark</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      },</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">&lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">script</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span></code></pre><h4 id="用户设置持久化" tabindex="-1">用户设置持久化 <a class="header-anchor" href="#用户设置持久化" aria-hidden="true">#</a></h4><p>再来我们需要让用户的设置可以持久化，我们就需要把用户的设置存在 <code>localStorage</code> 里。设置修改的时候存入 <code>localStorage</code>，每次页面加载的时候再读出来。边代码大家看一看就可以了，主要想让大家看到的一点就是在 Options API 里面，我们给现有的一个组件增加功能的时候，我们会在不同的地方插入代码。比如说在 <code>data</code> 里面声明状态，在 <code>methods</code> 加几个函数。我们插入非常零碎的几个片段去实现一个功能，当这个组件的代码变得非常的长的时候我们很容易去丢失掉单一功能的上下文。</p><p>那么在 Composition API 里，我们可以我们可以很好的把代码给组织在一起。像是这样的一个功能，就只需要在一个 Block 里面加入这些代码，我们可以很清楚的上有上下文，也可以有 TypeScript 进行检查。</p><p>以我们刚刚实现的 Dark Mode 为例，其实相对并不是一个非常复杂的功能，而我们已经写了这么多行的代码。如果在再这个组件继续的扩展的时候，会导致代码的整个结构变得非常的复杂，其实就是一个不是非常好的 Smell。这也是我们希望避免的一件事情。</p><p>那么我们会可能会希望我们可以把逻辑拿出来复用，或者是我们希望 Dark Mode 的这个功能，可以在另外的一个组件去做调用，或者是我就希望让整个代码看起来比较的干净。在 Options API 里面，我们是可以做到这一点，但是现有的几个方案都并不是非常的理想 (Mixin, Renderless Component, Vuex, etc.)</p><p>Mixin 问题是会有命名空间的冲突。像是我们刚刚的例子，我们会有一个 <code>updated</code> 的函数，那么如果我们在 Mixin 中使用 <code>updated</code> 这个函数，然后用户端在使用的时候如果没有注意到，他也自己写了一个 <code>updated</code> 函数，这就会导致函数覆盖，会出现一些不希望的情况，但是又很难去 debug。</p><p>Renderless Component 可以一定程度上解决命名空间的问题，但是他只能在模板里面使用，组合性也有很多的局限。</p><p>Vuex 的话要做到这些就会变得更加复杂，你需要去定义 Mutations 也需要去定义 Actions。然后再绑定一些浏览器的事件。</p><p>但是 Composition API 的话就变得非常的简单粗暴，我只需要把 <code>setup()</code> 的代码复制粘贴出去，然后用一个函数把它包装起来。那么在这里，我就只需要去调一个 use 就可以了。而且我们可以继续在这里面写更多的逻辑，同时也不会导致找不到对应的上下文。</p><h4 id="进一步复用" tabindex="-1">进一步复用 <a class="header-anchor" href="#进一步复用" aria-hidden="true">#</a></h4><p>我们甚至可以进行进一步的复用。以刚刚的代码为例，我们可以把这个 <code>useDark</code> 里面的这个 <code>matchMedia</code> 和用户设置的部分把他单独拉出来，变成两个独立的独立的函数。那么这些函数它就可以单独去专注在解决他单一问题上。以 <code>useDark</code> 的层面就只需要去在意，我在什么时候需要使用系统的设置和什么时候需要使用用户的设置。这里还有一个有趣的点，就是在这些组合工具里面他都可以使用生命周期的钩子，它就可以做到自动更新和自动注销。或者是说在数据改变的时候自动进行保存。</p><p>那么做到这一点的情况下，在使用的时候就可以没有什么负担。我只需要去在意他每一个 ref 对应什么样的功能，更新了之后它就可以帮我做到它应该做到的事情。这样对一个非常庞大的项目来说，可以更好的提高代码的复用度也可以提高代码的可读性跟可维护性。</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> useDark</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">system</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> usePreferDark</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">setting</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> useLocalStorage</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">setting-dark</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">auto</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">dark</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> computed</span><span style="--s-dark:#666666;--s-light:#999999">({</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    get</span><span style="--s-dark:#666666;--s-light:#999999">() {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> setting</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">auto</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">        ?</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> system</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">        :</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> setting</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">dark</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    },</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    set</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">v</span><span style="--s-dark:#666666;--s-light:#999999">) {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> system</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        setting</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999"> = </span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">auto</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      else</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        setting</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999"> = </span><span style="--s-dark:#BD976A;--s-light:#B07D48">v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ?</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">dark</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> :</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">light</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    },</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  })</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> dark</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> usePreferDark</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">media</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> window</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">matchMedia</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">(prefers-color-scheme: dark)</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">dark</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> ref</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">media</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">matches</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#80A665;--s-light:#59873A">update</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> dark</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> media</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">matches</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  media</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">addEventListener</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">change</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> update</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  onUnmounted</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    media</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">removeEventListener</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">change</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> update</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  })</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> dark</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> useLocalStorage</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">key</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> defaultValue</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">data</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> ref</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">localStorage</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">getItem</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">key</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ?? </span><span style="--s-dark:#BD976A;--s-light:#B07D48">defaultValue</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  watch</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">data</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> localStorage</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">setItem</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">key</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> data</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">))</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> data</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><h4 id="逻辑的组件" tabindex="-1">逻辑的组件 <a class="header-anchor" href="#逻辑的组件" aria-hidden="true">#</a></h4><p>所以我觉得对于这些可以被复用的这些函数来说，它更像是一个逻辑的组件。我们平常讲组件的时候，一般来说都是指UI组件。UI 组件我们可以把它抽象成这样一个情况，就是说 UI 组件接受一个 Props，也就是从他的父组件传进来的一些参数，然后会根据它的 State 去更新对应的UI，再以通过事件的形式去通知父组件。</p><p>那么换到逻辑组件来说，其实就是一个函数，函数可以接受一些参数。这些参数可以是普通参数，也可以是响应式的。然后在这些在这些函数里面，我们可以进行一些生命周期的绑定，可以去做一些对监听事件的销毁。最后我再回传出一些响应式的数据，这些数据可以是 <code>ref</code> 也可以是 <code>reactive</code>。同时这些响应的数据会根据其中内部的状态进行一些更新，可以达到类似事件通知的效果。其实右边这张图是给 UI 组件的一张图，但是我觉得他也同样适用于逻辑组件。</p><p>也就是说，我可以复用底层的 <code>useLocalStorage</code> <code>useQuery</code> 去实现一个更高层的逻辑组件。让每一层组件都专注于在做自己的事情上就好了。</p><h4 id="现有逻辑组件库" tabindex="-1">现有逻辑组件库 <a class="header-anchor" href="#现有逻辑组件库" aria-hidden="true">#</a></h4><p>现有的 Vue 3 已经可以使用的有两个主要的逻辑的组件库，<a href="https://github.com/antfu/vueuse" target="_blank" rel="noopener"><code>VueUse</code></a> 和 <a href="https://github.com/pikax/vue-composable" target="_blank" rel="noopener"><code>vue-composable</code></a>。有点像 React 中的 <code>react-use</code> 或者 <code>ahooks</code> 这一类的工具。VueUse 提供了更加细粒度的 Web API 以及工具分装。<code>vue-composable</code> 是由另外一个 Core Team Member <a href="https://github.com/pikax" target="_blank" rel="noopener">@pikax</a> 做的，它提供了更多常用的逻辑封装。例如 <code>useI18n</code>, <code>useValidation</code> 等等。这些功能直接实现在了这个工具里面，而不需要再去安装另外依赖于别的库的。</p><h3 id="组合式-api-生态" tabindex="-1">组合式 API 生态 <a class="header-anchor" href="#组合式-api-生态" aria-hidden="true">#</a></h3><p>然后和大家简单讲一下组合式 API 的生态支持。在 DevTools 6.0.0-beta.2 的更新了之后，加入了 Vue 3 的支持，同时加入一个新的功能是 Timeline 这个自定义的事件的打点，他可以去监听整个应用里面发生的各种各样的事件，然后把它做成一个个的点，让你可以去以时间的维度知道发生了什么。</p><p>然后在 <code>vue-composable</code> 里面提供了一个非常有趣的 API 叫做 <code>useDevtoolsInspector</code>，你可以传一些响应式的数据，当这些数据更新的时候去打点在 Timeline。你就可以更好的知道你的这些响应式的数据什么时候被什么时候被更新了以及更新成了什么。</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">import</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> useDevtoolsInspector</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> from</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">vue-composable</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">counter</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> ref</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#4C9A91;--s-light:#2F798A">0</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">useDevtoolsInspector</span><span style="--s-dark:#666666;--s-light:#999999">({ </span><span style="--s-dark:#BD976A;--s-light:#B07D48">counter</span><span style="--s-dark:#666666;--s-light:#999999"> })</span></span></code></pre><p>然后再来一个就是 SFC 的单文件组件的一些更新。我们给 <code>script</code> 标签加了一个 <code>setup</code> 的 flag。那么通过 <code>&lt;script setup&gt;</code>，我就可以把原本的这个 <code>defineComponent</code> 的形式的变成了 ES Module 的形式。本来可能本来会需要说我们再说说我们在声明了很多的 <code>ref</code> 之后，我们需要在最后把他们的名字全部都记下来最后一起返回出去。这时候，如果我们这个中间的逻辑非常的长的时候，就会很容易忘记某一些东西而没有暴露在组件的实例上，他们就没有办法在模板上使用。</p><p>那么有了这个 <code>&lt;script setup&gt;</code> 之后，我们就可以在任意的地方去把我们声明出来的数据直接 <code>export</code> 出去，他就会直接暴露在这个组件的实例上。同时我们可以通过这个 API 导出直接 export 另外一个组件达到子组件的注册。也为可以在一些 module 里面放一些全局的状态，多个组件 export 一个 store 的时候，我们就可以做到一个天然的状态共享。</p><h3 id="vue-2-3-同构" tabindex="-1">Vue 2 &amp; 3 同构 <a class="header-anchor" href="#vue-2-3-同构" aria-hidden="true">#</a></h3><p>我们以一个工具库的维护者来说，我们要怎么去做到 Vue 2 &amp; 3 的代码的同构。在 Vue 2 里面，其实是没有提供 Composition API 的。而我们是通过一个另外的这个插件去做到这件事的。那么这样就会造成一个问题，我们引入的同样的 API，但是在不同的版本会从不同的入口引入。就会造成你的代码没有办法直接搬过去做一个同时兼容两个版本的状态。</p><p>解决方案就是我们可能需要维护两个版本，通过发布不同的 npm 包实现实现不同的版本，再让用户安装的时候去指定他要安装哪个版本。或者是说我们可能可以只维护一份代码，但是我们写一个发布的脚本，在打包的时候去替换掉我们刚刚讲的这个 API。那我们可以在针对 Vue 3 的时候直接从 <code>vue</code> 里面引入这些API，在针对 Vue 2 的时候从 <code>@vue/composition-api</code>。但是这样的问题虽然你让你更加轻松的只维护一份代码，但是你还是同时要发布两份版本，因为这两个版本的代码是还是没有办法兼容的。</p><p>为了解决这个问题，我做了一个工具叫做 <a href="https://github.com/antfu/vue-demi" target="_blank" rel="noopener"><code>vue-demi</code></a>，它是一个为工具库服务的工具。如果使用 <code>vue-demi</code> 的话你只需要重构代码从 <code>vue-demi</code> 里面引入所有和 Vue 有关的 API，像是 <code>ref</code> 和 <code>reactive</code>。<code>vue-demi</code> 会使用 <code>postintall</code> 去检测当前的 Vue 版本，然后根据用户安装的版本去重新定向到对应的 <code>vue</code> 或者 <code>@vue/composition-api</code> 的包。那么这样的话我们就实现了同一个包 npm 包可以同时 Vue 2 和 3 两个版本。</p><p>如果需要进行一些单元测试的话，大家可以去看看 @pikax 的这个关于 <a href="https://dev.to/pikax/how-to-test-your-library-for-vue-2-and-vue-next-42ao" target="_blank" rel="noopener">单元测试同时兼容两个版本的文章</a>。</p><h3 id="vue-reactivity" tabindex="-1">Vue Reactivity <a class="header-anchor" href="#vue-reactivity" aria-hidden="true">#</a></h3><p>我们聊一聊 <code>@vue/reactivity</code> 这个灵活的响应式的系统。这个包有一个非常大的卖点就是它是和 UI 或者说这个响应式系统是和 Vue 的组件模型结构的。那么这是尤大前段时间发的一篇推，它主要讲了就是说我们的响应式系统可以在不同的环境也在不同的框架上复用。也就是说你可以自己根据这个 Reactivity 写一套自己的框架，或者甚至你可以把它拿来用在 Node.js 或者是用在别的地方。</p><p>那么是由他在推特上发的两个例子，一个是 <code>vue</code> + <code>htm</code>，<code>htm</code> 是一个在客户端渲染的 JSX 的方案。那么这样的一个例子，我们直接可以非常简单地使用 Vue 的响应式系统去绑定到这个 <code>htm</code> 这个包上，然后我们就可以实现一个在纯客户端上不需要打包工具的一个 Vue + JSX 的支持。</p><p>另外一个例子是 <code>@vue/reactivity</code> + <code>lit-html</code>, <code>lit-html</code> 是一个 HTML 的模板引擎。我们只用到了最轻量的 <code>@vue/reactivity</code> 也是达到类似的纯客户端的效果。那么这个东西后来尤大在前几天的时候，把它做成了一个叫做 <a href="https://github.com/yyx990803/vue-lit" target="_blank" rel="noopener"><code>@vue/lit</code></a> 一个工具，大家也可以有兴趣的话可以去试一下。</p><h4 id="reactivue" tabindex="-1">Reactivue <a class="header-anchor" href="#reactivue" aria-hidden="true">#</a></h4><p>然后再来就是我之前做的一个 Proof of Concept，叫做 <a href="https://github.com/antfu/reactivue" target="_blank" rel="noopener">ReactiVue</a>。在 React 中使用 Vue 的 Composition API。可以看到右边的这个例子，ReactiVue 是一个以 React Hooks 形式实现的，<code>useSetup</code> 提供一个和 Vue 等价的 <code>setup()</code> 函数。最后 return 的响应式数据会再传出来给 React 组件，当响应式数据更新时会触发 React 组件的重新渲染。ReactiVue 只依赖于 <code>@vue/reactivity</code>，同时又包装了 React 的生命周期，让他们以 Vue 的形式暴露出来。这样就可以去复用 Vue 的组件库，我们这边做了测试的有 VueUse 和 <a href="https://github.com/posva/pinia" target="_blank" rel="noopener">pinia</a>，通过包的重命名就可以直接导出使用。</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-tsx"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">import</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> React</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> from</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">React</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">import</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> computed</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> ref</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> useSetup</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> from</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">reactivue</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> MyCounter</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">props</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> counter</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> doubled</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> inc</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> useSetup</span><span style="--s-dark:#666666;--s-light:#999999">(</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">props</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">      const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> counter</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> ref</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">props</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">      const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> doubled</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> computed</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> counter</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> *</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">      const</span><span style="--s-dark:#80A665;--s-light:#59873A"> inc</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> counter</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> +=</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 1</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> counter</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> doubled</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> inc</span><span style="--s-dark:#666666;--s-light:#999999"> }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    },</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    props</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  )</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#666666;--s-light:#999999"> (</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    &lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">div</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      &lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">div</span><span style="--s-dark:#666666;--s-light:#999999">&gt;{</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">`</span><span style="--s-dark:#666666;--s-light:#999999">${</span><span style="--s-dark:#C98A7D;--s-light:#B56959">counter</span><span style="--s-dark:#666666;--s-light:#999999">}</span><span style="--s-dark:#C98A7D;--s-light:#B56959"> x 2 = </span><span style="--s-dark:#666666;--s-light:#999999">${</span><span style="--s-dark:#C98A7D;--s-light:#B56959">doubled</span><span style="--s-dark:#666666;--s-light:#999999">}</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">`</span><span style="--s-dark:#666666;--s-light:#999999">}&lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">div</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      &lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">button</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> onClick</span><span style="--s-dark:#666666;--s-light:#999999">={</span><span style="--s-dark:#BD976A;--s-light:#B07D48">inc</span><span style="--s-dark:#666666;--s-light:#999999">}&gt;</span><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">Increase</span><span style="--s-dark:#666666;--s-light:#999999">&lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">button</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    &lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">div</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  )</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">ReactDOM</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">render</span><span style="--s-dark:#666666;--s-light:#999999">(&lt;</span><span style="--s-dark:#B8A965;--s-light:#998418">MyCounter</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> value</span><span style="--s-dark:#666666;--s-light:#999999">={</span><span style="--s-dark:#4C9A91;--s-light:#2F798A">10</span><span style="--s-dark:#666666;--s-light:#999999">}</span><span style="--s-dark:#666666;--s-light:#999999"> /&gt;,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> el</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span></code></pre><h4 id="vue-reactivity-1" tabindex="-1">@vue-reactivity <a class="header-anchor" href="#vue-reactivity-1" aria-hidden="true">#</a></h4><p><a href="https://github.com/vue-reactivity" target="_blank" rel="noopener"><code>@vue-reactivity</code></a> 是一个我对于 <code>@vue/reactivity</code> 一些可能性的探索。我希望它会个一系列的工具包。我们现在有的两个已经发布了的工具。其中一个是 <a href="https://github.com/vue-reactivity/watch" target="_blank" rel="noopener"><code>@vue-reactivity/watch</code></a>，在 Vue 中 <code>watch</code> 是实现在 <code>@vue/runtime-core</code> 里的，因为 <code>watch</code> 和 Vue 的组件模型有一些生命周期上的强绑定。那么我们在这里把 Vue 的 <code>watch</code> 提取出来做了一些简化之后，你就可以直接在 <code>@vue/reactivity</code> 使用 <code>watch</code>。</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">import</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> computed</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> reactive</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> ref</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> from</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">@vue/reactivity</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">import</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> watch</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> watchEffect</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> from</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">@vue-reactivity/watch</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">count</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> ref</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#4C9A91;--s-light:#2F798A">1</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">stopWatch</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> watch</span><span style="--s-dark:#666666;--s-light:#999999">(</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  count</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">newValue</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">`</span><span style="--s-dark:#C98A7D;--s-light:#B56959">Count: </span><span style="--s-dark:#666666;--s-light:#999999">${</span><span style="--s-dark:#C98A7D;--s-light:#B56959">newValue</span><span style="--s-dark:#666666;--s-light:#999999">}</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">`</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">count</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> +=</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 1</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// Count: 2</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">stopWatch</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span></code></pre><p>另外一个是 <a href="https://github.com/vue-reactivity/scope" target="_blank" rel="noopener"><code>@vue-reactivity/scope</code></a>，作用是做 <code>effect</code> 的自动收集。我们可以使用 <code>effectScope</code>，在这个里面声明的所有的 <code>effect</code> 都会被自动收集，我们就可以直接通过一个 <code>stop()</code> 函数去清除掉所有的这些 <code>effects</code>。这其实类似于类似于组件的 <code>setup()</code> 函数，是它的内部实现没有暴露出来，所以我们实现了这样的一个功能。关于这个我提了一个 RFC，希望我们可以把这个功能加入到 <code>@vue/reactivity</code> 本身上，然后可以提供给更多的库去做使用。</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">import</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  computed</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  effectScope</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  ref</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  watch</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> from</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">@vue-reactivity/scope</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">counter</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> ref</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#4C9A91;--s-light:#2F798A">0</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">stop</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> effectScope</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">doubled</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> computed</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> counter</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> * </span><span style="--s-dark:#4C9A91;--s-light:#2F798A">2</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  watch</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">doubled</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">double</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">))</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  watchEffect</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">Count: </span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> double</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">))</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">})</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// to dispose all effects</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">stop</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span></code></pre><p>然后再来一些实验性的想法，一个是 <code>/lifecycle</code>，希望可以有一个生命周期钩子的实现可以去复用，更容易让我们在 Vue 响应式的基础上做出自己的框架。另外一个有趣的就是这个 filesystem, 一个响应式的文件系统。这边有一个简单的例子，我们可以从 <code>@vue-reactivity/fs</code> 里面去引入一个叫做 <code>useJSON</code> 的一个钩子, 我们给他传一个 <code>data.json</code> 作为文件路径。它会去读取这个文件后解析成 JSON 对象暴露在 <code>data</code> 上，我们可以监听<code>data</code> 就可以知道数据的改变，那么同时也可以通过这样的API，去修改 <code>data</code> 的值，然后可以把数据写回对应的 JSON 文件。</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">import</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> effect</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> from</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">@vue/reactivity</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">import</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> useJSON</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> from</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">@vue-reactivity/fs</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">data</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> useJSON</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">data.json</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// log on file changes</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">effect</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">data</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">})</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// write back to file</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">data</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999"> = { </span><span style="--s-dark:#B8A965;--s-light:#998418">foo</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">bar</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999"> }</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">data</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">hello</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">world</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span></span></code></pre><p>这些就是我现在正在做的一些探索，我觉得 Vue 的响应式系统非常的有趣，也相信未来还会有更多的的可能性和应用场景，希望可以和大家一起进行进一步的探索，找到一些有趣的使用方式和最佳实践。</p><p>我的分享就到这里，如果有任何问题欢迎通过 <a href="mailto:hi@antfu.me">hi@antfu.me</a> 给我发送邮件。谢谢大家.</p></div><!--]--></article><div class="prose m-auto mt-8 mb-8 slide-enter animate-delay-500 print:hidden"><!--[--><span font-mono="" op50="">&gt; </span><span op50="">comment on </span><a href="https://elk.zone/intent/post?text=Reading%20%40antfu%40m.webtoo.ls's%20https%3A%2F%2Fantfu.me%2Fposts%2Fbinfe-2020-zh%0A%0AI%20think..." target="_blank" op50="">mastodon</a><span op25=""> / </span><a href="https://twitter.com/intent/tweet?text=Reading%20%40antfu7's%20https%3A%2F%2Fantfu.me%2Fposts%2Fbinfe-2020-zh%0A%0AI%20think..." target="_blank" op50="">twitter</a><!--]--><br><span font-mono="" op50="">&gt; </span><a href="/posts" class="font-mono op50 hover:op75"></a></div><!--]--><div class="mt-10 mb-6 prose m-auto flex slide-enter animate-delay-1200!"><span class="text-sm op50">It's a Long Way to the Top (If You Wanna Rock 'N' Roll) - ACDC 🎸</span><div class="flex-auto"></div></div></main><!----><!--]--></div><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></body></html>